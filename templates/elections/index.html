{% extends "elections/base.html" %}
{% load static %}

{% block title %}首页 - 总统选举投票系统{% endblock %}

{% block content %}
<div class="main-content">
    <!-- 侧边栏 -->
    <aside class="sidebar">
        <h3><i class="fas fa-user-check"></i> 投票状态</h3>
        
        <div class="status-card">
            <div class="status-icon {% if has_voted %}voted{% else %}not-voted{% endif %}">
                <i class="fas {% if has_voted %}fa-check-circle{% else %}fa-clock{% endif %}"></i>
            </div>
            <h4>{% if has_voted %}您已完成投票{% else %}您尚未投票{% endif %}</h4>
            <p>{% if has_voted %}感谢您行使民主权利！您的投票已被安全记录。{% else %}请选择您支持的候选人进行投票。{% endif %}</p>
            {% if has_voted and vote_timestamp %}
            <p class="vote-time">投票时间: {{ vote_timestamp }}</p>
            {% endif %}
        </div>
        
        {% if current_election %}
        <div class="deadline-info">
            <h4><i class="fas fa-clock"></i> 投票截止时间</h4>
            <p>{{ current_election.end_date|date:"Y年m月d日" }} 晚上8:00</p>
            <p>剩余时间: {{ remaining_time }}</p>
        </div>
        {% endif %}
        
        <h3 style="margin-top: 30px;"><i class="fas fa-exclamation-circle"></i> 重要提醒</h3>
        
        <div class="info-item">
            <i class="fas fa-fingerprint"></i>
            <div>投票系统采用多重身份验证，确保安全性</div>
        </div>
        
        <div class="info-item">
            <i class="fas fa-lock"></i>
            <div>您的投票信息完全匿名且加密存储</div>
        </div>
        
        <div class="info-item">
            <i class="fas fa-shield-alt"></i>
            <div>投票后无法更改，请谨慎选择</div>
        </div>
        
        <div class="info-item">
            <i class="fas fa-history"></i>
            <div>选举结果将于投票截止后24小时内公布</div>
        </div>
        
        <!-- 实时统计 -->
        <div class="stats-card">
            <h3><i class="fas fa-chart-bar"></i> 实时统计</h3>
            <div class="stat-item">
                <span class="stat-label">总投票数:</span>
                <span class="stat-value">{{ total_votes }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">选举状态:</span>
                <span class="stat-value status-{% if current_election.is_active %}active{% else %}ended{% endif %}">
                    {% if current_election.is_active %}进行中{% else %}已结束{% endif %}
                </span>
            </div>
            <div class="stat-item">
                <span class="stat-label">候选人:</span>
                <span class="stat-value">{{ candidates|length }}位</span>
            </div>
        </div>
    </aside>
    
    <!-- 主要内容 -->
    <section class="content">
        <h2 class="section-title">2023年总统选举投票</h2>
        <p class="section-subtitle">请仔细阅读候选人信息，然后选择您支持的总统候选人。每位选民只能投票一次，投票后不可更改。</p>
        
        {% if current_election and not current_election.is_active %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>选举已结束</strong> - 投票通道已关闭，您可以在结果页面查看最终选举结果。
        </div>
        {% elif has_voted %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <strong>您已完成投票</strong> - 感谢您参与本次总统选举。您可以在结果页面查看实时投票情况。
        </div>
        {% endif %}
        
        <!-- 候选人列表 -->
        <div class="candidates-grid">
            {% for candidate in candidates %}
            <div class="candidate-card" data-candidate-id="{{ candidate.id }}">
                <div class="candidate-header" style="background: linear-gradient(to right, {{ candidate.color }}, {{ candidate.light_color|default:candidate.color }});">
                    <div class="candidate-photo">
                        {% if candidate.photo %}
                        <img src="{{ candidate.photo.url }}" alt="{{ candidate.full_name }}">
                        {% else %}
                        <i class="fas fa-user-tie"></i>
                        {% endif %}
                    </div>
                    <div class="candidate-name">{{ candidate.full_name }}</div>
                    <div class="candidate-party">{{ candidate.party }}</div>
                </div>
                
                <div class="candidate-info">
                    <p class="candidate-bio">{{ candidate.bio|truncatechars:150 }}</p>
                    
                    <div class="candidate-stats">
                        <div class="stat">
                            <div class="stat-value">{{ candidate.percentage|floatformat:1 }}%</div>
                            <div class="stat-label">当前支持率</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">{{ candidate.vote_count }}</div>
                            <div class="stat-label">获得票数</div>
                        </div>
                    </div>
                    
                    {% if current_election and current_election.is_active and not has_voted %}
                    <button class="vote-btn" onclick="openVoteModal({{ candidate.id }}, '{{ candidate.full_name|escapejs }}', '{{ candidate.party|escapejs }}')" style="background-color: {{ candidate.color }};">
                        <i class="fas fa-check-circle"></i> 投票给{{ candidate.full_name }}
                    </button>
                    {% elif has_voted %}
                    <button class="vote-btn" disabled>
                        <i class="fas fa-check"></i> 您已投票
                    </button>
                    {% else %}
                    <button class="vote-btn" disabled>
                        <i class="fas fa-times"></i> 选举已结束
                    </button>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="no-candidates">
                <i class="fas fa-user-slash"></i>
                <p>暂无候选人信息</p>
            </div>
            {% endfor %}
        </div>
        
        <!-- 实时结果图表 -->
        <div class="results-container">
            <h3 class="section-title">当前投票结果</h3>
            <p class="section-subtitle">以下是根据已投选票统计的实时结果</p>
            
            <div class="results-chart">
                {% for candidate in candidates %}
                {% with bar_height=candidate.percentage|floatformat:0|add:"0" %}
                <div class="chart-bar">
                    <div class="bar" style="height: {% if bar_height <= 100 %}{{ bar_height }}{% else %}100{% endif %}%; background-color: {{ candidate.color }};"></div>
                    <div class="bar-label">{{ candidate.full_name|truncatechars:3 }}</div>
                    <div class="bar-value">{{ candidate.vote_count }}票 ({{ candidate.percentage|floatformat:1 }}%)</div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            
            <div class="chart-footer">
                <div class="last-update">
                    <i class="fas fa-sync-alt"></i> 最后更新: <span id="last-update-time">正在加载...</span>
                </div>
                <button class="btn-refresh" onclick="refreshResults()">
                    <i class="fas fa-redo"></i> 刷新数据
                </button>
            </div>
        </div>
    </section>
</div>

<!-- 投票确认模态框 -->
<div class="modal-overlay" id="voteModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-vote-yea"></i> 确认投票</h3>
            <button class="close-modal" onclick="closeVoteModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="confirmation-text">
                <p>您确定要投票给</p>
                <p><strong id="candidate-name-confirm">候选人姓名</strong></p>
                <p>所属党派: <span id="candidate-party-confirm">政党名称</span></p>
                <p style="margin-top: 15px; font-size: 15px; color: var(--warning-color);">
                    <i class="fas fa-exclamation-triangle"></i> 请注意：投票后无法更改，请确认您的选择。
                </p>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-confirm" onclick="submitVote()">
                    <i class="fas fa-check"></i> 确认投票
                </button>
                <button class="btn btn-cancel" onclick="closeVoteModal()">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 投票成功模态框 -->
<div class="modal-overlay" id="successModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-check-circle" style="color: var(--success-color);"></i> 投票成功</h3>
            <button class="close-modal" onclick="closeSuccessModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="confirmation-text" style="background-color: #d1fae5;">
                <p style="font-size: 18px; color: var(--success-color); margin-bottom: 15px;">
                    <i class="fas fa-check-circle"></i> 您的投票已成功提交！
                </p>
                <p>感谢您行使民主权利，参与2023年总统选举投票。</p>
                <p>您的投票信息已被安全记录，选举结果将于投票截止后公布。</p>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-confirm" onclick="closeSuccessModal()">
                    <i class="fas fa-thumbs-up"></i> 完成
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // ================== 新增：获取 CSRF Token 的函数 ==================
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // =============================================================

    // 全局变量
    let selectedCandidateId = null;
    let selectedCandidateName = '';
    let selectedCandidateParty = '';
    
    // 打开投票确认模态框
    function openVoteModal(candidateId, candidateName, candidateParty) {
        selectedCandidateId = candidateId;
        selectedCandidateName = candidateName;
        selectedCandidateParty = candidateParty;
        
        document.getElementById('candidate-name-confirm').textContent = candidateName;
        document.getElementById('candidate-party-confirm').textContent = candidateParty;
        
        document.getElementById('voteModal').classList.add('active');
    }
    
    // 关闭投票确认模态框
    function closeVoteModal() {
        document.getElementById('voteModal').classList.remove('active');
    }
    
    // 提交投票
    function submitVote() {
        closeVoteModal();
        
        // 修复：简化 URL 构造方式
        // 确保 current_election 存在，否则会报错
        var electionId = "{{ current_election.id|default:0 }}";
        var voteUrl = "/elections/" + electionId + "/vote/" + selectedCandidateId + "/";

        // 发送投票请求到服务器
        $.ajax({
            url: voteUrl,
            method: "POST",
            headers: {
                "X-CSRFToken": getCookie('csrftoken')  // 修复：添加 CSRF Token
            },
            data: {
                candidate_id: selectedCandidateId
            },
            success: function(response) {
                if (response.success) {
                    // 更新UI显示用户已投票
                    document.querySelectorAll('.vote-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-check"></i> 您已投票';
                    });
                    
                    // 显示成功消息
                    setTimeout(() => {
                        document.getElementById('successModal').classList.add('active');
                    }, 500);
                    
                    // 更新用户状态显示
                    document.querySelector('.user-status').innerHTML = 
                        '<span class="status-badge voted"><i class="fas fa-check-circle"></i> 已投票</span>';
                        
                    // 更新状态卡片
                    document.querySelector('.status-card h4').textContent = '您已完成投票';
                    document.querySelector('.status-card p').textContent = '感谢您行使民主权利！您的投票已被安全记录。';
                    document.querySelector('.status-icon').innerHTML = '<i class="fas fa-check-circle"></i>';
                    document.querySelector('.status-icon').className = 'status-icon voted';
                    
                } else {
                    alert('投票失败: ' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error("Error:", error);
                alert('网络错误，请稍后重试');
            }
        });
    }
    
    // 关闭成功模态框
    function closeSuccessModal() {
        document.getElementById('successModal').classList.remove('active');
        // 刷新页面以更新数据
        setTimeout(() => location.reload(), 500);
    }
    
    // 更新投票结果
    function updateResults() {
        $.ajax({
            url: "{% url 'elections:api_results' %}",
            method: "GET",
            success: function(response) {
                if (response.success) {
                    // 更新图表数据
                    response.results.forEach(candidate => {
                        // 更新候选人卡片上的票数
                        const card = document.querySelector(`.candidate-card[data-candidate-id="${candidate.id}"]`);
                        if (card) {
                            const statValues = card.querySelectorAll('.stat-value');
                            if (statValues.length >= 2) {
                                statValues[0].textContent = candidate.percentage.toFixed(1) + '%';
                                statValues[1].textContent = candidate.votes;
                            }
                        }
                    });
                    
                    // 更新最后更新时间
                    document.getElementById('last-update-time').textContent = response.timestamp;
                }
            },
            error: function() {
                console.error("更新结果失败");
            }
        });
    }
    
    // 刷新结果
    function refreshResults() {
        updateResults();
        const btn = document.querySelector('.btn-refresh');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 更新中...';
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-redo"></i> 刷新数据';
        }, 1000);
    }
    
    // 页面加载完成后初始化
    $(document).ready(function() {
        // 设置最后更新时间
        const now = new Date();
        document.getElementById('last-update-time').textContent = now.toLocaleString('zh-CN');
        
        // 开始自动更新结果（每30秒）
        setInterval(updateResults, 30000);
        
        // 点击模态框外部关闭
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        // 如果用户已投票，禁用所有投票按钮
        {% if has_voted %}
        document.querySelectorAll('.vote-btn').forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-check"></i> 您已投票';
        });
        {% endif %}
    });
</script>
{% endblock %}
